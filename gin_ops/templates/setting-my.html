<!doctype html>
<!--
* Tabler - Premium and Open Source dashboard template with responsive and high quality UI.
* @version 1.0.0-beta20
* @link https://tabler.io
* Copyright 2018-2023 The Tabler Authors
* Copyright 2018-2023 codecalm.net PaweÅ‚ Kuna
* Licensed under MIT (https://github.com/tabler/tabler/blob/master/LICENSE)
-->
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>è®¾ç½®-ä¸ªäººè®¾ç½®</title>

</head>

<body class="d-flex flex-column">
  <div class="page">
    <!-- Navbar -->
    {{if .is_login}}
    {{template "header-logined.html" .}}
    {{else}}
    {{template "header-no-login.html"}}
    {{end}}

    <header class="navbar-expand-md">

    </header>

    <div class="page-wrapper">
      <!-- Page header -->
      <div class="page-header d-print-none">
        <div class="container-xl">
          <div class="row g-2 align-items-center">
            <div class="col">
              <h2 class="page-title">
                è®¾ç½®
              </h2>
            </div>
          </div>
        </div>
      </div>
      <!-- Page body -->
      <div class="page-body">
        <div class="container-xl">
          <div class="card">
            <div class="row g-0">

              <div class="col-12 col-md-3 border-end">
                <div class="card-body">
                  <h4 class="subheader">è´¦å·è®¾ç½®</h4>
                  <div class="list-group list-group-transparent">
                    <a href="#" class="list-group-item list-group-item-action d-flex align-items-center active">ä¿¡æ¯è®¾ç½®</a>
                    <a href="/setting-security"
                      class="list-group-item list-group-item-action d-flex align-items-center">å®‰å…¨è®¾ç½®</a>
                  </div>
                  <h4 class="subheader mt-4">å¤–éƒ¨è®¾ç½®</h4>
                  <div class="list-group list-group-transparent">

                  </div>
                </div>
              </div>

              <div class="col-12 col-md-9 d-flex flex-column">
                <div class="card-body">
                  <h2 class="mb-4">ä¿¡æ¯è®¾ç½®</h2>
                  <!-- <h3 class="card-title">Profile Details</h3> -->
                  <div class="row align-items-center">
                    <div class="col-auto"><span id="myAvatar" class="avatar avatar-xl"
                        style="background-image: url({{.user_info.AvatarPath}})"></span>
                    </div>
                    <div class="col-auto"><a href="#" class="btn" onclick="avatar_toolt.show()">
                        æ›´æ”¹å¤´åƒ
                      </a></div>
                    <!-- <div class="col-auto"><a href="#" class="btn btn-ghost-danger">
                        åˆ é™¤å¤´åƒ
                      </a></div> -->
                  </div>
                  <!-- <h3 class="card-title mt-4">Business Profile</h3> -->
                  <div class="row g-3">
                    <div class="col-md">
                      <div class="form-label">åå­—</div>
                      <input id="username" type="text" class="form-control" value="{{.user_info.Username}}"
                        maxlength="30">
                    </div>

                    <div class="col-md">
                      <div class="form-label">å¤‡æ³¨</div>
                      <input id="first_name" type="text" class="form-control" value="{{.user_info.FirstName}}"
                        maxlength="50">
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">ç”Ÿæ—¥</label>
                    <div class="row g-2">
                      <div class="col-5">
                        <input type="text" class="form-control" id="birthday-picker" placeholder="é€‰æ‹©ç”Ÿæ—¥"
                          value="{{.user_info.Birthdate}}">
                      </div>
                    </div>
                  </div>


                </div>

                <div class="card-footer bg-transparent mt-auto">
                  <div class="btn-list justify-content-end">

                    <a href="#" onclick="updata_user_info()" class="btn btn-primary">
                      æäº¤
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    {{template "footer.html"}}
  </div>

</body>

</html>

<div class="modal modal-blur fade" id="avata_toolt" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="container">
        <h1>å¤´åƒè£å‰ªå·¥å…·</h1>

        <div class="flex-wrapper">
          <!-- å·¦ä¾§è£å‰ªåŒº -->
          <div class="crop-section">
            <div id="image-wrapper">
              <img id="cropper-image"
                src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
            </div>
            <!-- ä¸Šä¼ è¿›åº¦ -->
            <div class="progress-container">
              <div class="progress-bar"></div>
            </div>

            <!-- æ¶ˆæ¯æç¤º -->
            <div id="message" class="alertavater"></div>

            <div class="preview-stats">
              <!-- <p>å½“å‰ç¼©æ”¾: <span id="zoomValue">100%</span></p> -->
              <p>å›¾ç‰‡å°ºå¯¸: <span id="imageSize">0 x 0</span></p>
            </div>
          </div>

          <!-- å³ä¾§é¢„è§ˆåŒº -->
          <div class="preview-section">
            <h3>å®æ—¶é¢„è§ˆ</h3>
            <div class="preview-box">
              <img id="preview-img"
                src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
              <label class="btn btn-primary">
                ğŸ“ é€‰æ‹©å›¾ç‰‡
                <input type="file" id="fileInput" accept="image/*">
              </label>
              <button class="btn btn-secondary " onclick="rotateImage(-90)">â†©ï¸ å·¦æ—‹</button>
              <button class="btn btn-success " id="uploadBtn">âœ‚ï¸ è£å‰ªå¤´åƒ</button>

              <button class="btn btn-danger " style="margin-top: 150px;" onclick="avatar_toolt.hide()">âŒ å–æ¶ˆ</button>



            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<style>
  /* ä¸»å®¹å™¨ */
  .litepicker {
    --color-primary: #4f46e5;
    /* ä¸»é¢˜è‰²ï¼ˆé€‰ä¸­æ—¥æœŸ/æŒ‰é’®ï¼‰ */
    --color-primary-light: #e0e7ff;
    --color-text: #1f2937;
    /* æ–‡æœ¬é¢œè‰² */
    --color-text-light: #6b7280;
    --font-family: 'Inter', sans-serif;
    /* è‡ªå®šä¹‰å­—ä½“ */
  }

  /* æ—¥æœŸå•å…ƒæ ¼æ‚¬åœæ•ˆæœ */
  .litepicker .container__days .day-item:hover {
    background: #f3f4f6;
  }

  .litepicker {
    border-radius: 8px;
    /* æ•´ä½“åœ†è§’ */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .litepicker .container__months {
    gap: 24px;
    /* æœˆä»½ä¹‹é—´çš„é—´è· */
  }

  @media (max-width: 640px) {
    .litepicker {
      width: 100% !important;
      /* å…¨å±å®½åº¦ */
    }

    .litepicker .container__months {
      flex-direction: column;
      /* å‚ç›´æ’åˆ— */
    }
  }


  /* å¤´åƒè£å‰ªå™¨æ ·å¼*/

  .container {
    width: 95%;
    /* æ”¹ä¸ºç™¾åˆ†æ¯”å®½åº¦ */
    margin: 20px auto;
    /* å¢åŠ ä¸Šä¸‹è¾¹è· */
    max-width: 1200px;
    /* ä¿ç•™æœ€å¤§å®½åº¦ */
    background: white;
    padding: 30px;
    border-radius: 12px;

  }

  .flex-wrapper {
    display: flex;
    gap: 30px;
    margin-top: 20px;
    flex-wrap: wrap;
    /* æ·»åŠ æ¢è¡Œæ”¯æŒ */
  }

  /* è£å‰ªåŒºåŸŸ */
  .crop-section {
    flex: 1 1 60%;
    /* å¼¹æ€§å¸ƒå±€åŸºç¡€å®½åº¦ */
    min-width: 300px;
    /* é™ä½æœ€å°å®½åº¦ */
    height: auto;
    /* ç§»é™¤å›ºå®šé«˜åº¦ */
    min-height: 400px;
    /* è®¾ç½®æœ€å°é«˜åº¦ */
  }

  #image-wrapper {
    width: 100%;
    height: 60vh;
    /* æ”¹ç”¨è§†çª—å•ä½ */
    max-height: 600px;
    /* è®¾ç½®æœ€å¤§é«˜åº¦ */
    background: #f8f9fa;
    border: 2px dashed #ddd;
    border-radius: 8px;
    overflow: hidden;
  }

  /* é¢„è§ˆåŒºåŸŸè‡ªé€‚åº” */
  .preview-section {
    flex: 1 1 35%;
    /* å¼¹æ€§å¸ƒå±€åŸºç¡€å®½åº¦ */
    min-width: 250px;
    /* è®¾ç½®åˆç†æœ€å°å®½åº¦ */
  }

  /* ç§»åŠ¨ç«¯é€‚é… */
  @media (max-width: 768px) {
    .container {
      padding: 15px;
      /* å‡å°‘å†…è¾¹è· */
    }

    .flex-wrapper {
      flex-direction: column;
      /* å‚ç›´æ’åˆ— */
    }

    .crop-section,
    .preview-section {
      width: 100% !important;
      /* å¼ºåˆ¶å…¨å®½ */
      min-width: unset;
      /* ç§»é™¤æœ€å°å®½åº¦ */
    }

    #image-wrapper {
      height: 50vh;
      /* è°ƒæ•´ç§»åŠ¨ç«¯é«˜åº¦ */
    }

    .preview-box {
      width: 120px;
      /* ç¼©å°é¢„è§ˆåŒºåŸŸ */
      height: 120px;
    }

    .controls {
      flex-direction: column;
      /* å‚ç›´æ’åˆ—æŒ‰é’® */
      margin-top: 10px;
    }
  }


  #cropper-image {
    max-width: none !important;
    max-height: none !important;
  }

  /* æ§åˆ¶åŒºåŸŸ */
  .controls {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }

  /* é¢„è§ˆåŒºåŸŸ */
  .preview-section {
    flex: 1;
    min-width: 50px;
  }

  .preview-box {
    width: 150px;
    height: 150px;
    /* border-radius: 50%; */
    border: 3px solid var(--primary-color);
    overflow: hidden;
    margin: 0 auto 20px;
  }

  #preview-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }



  /* ä¸Šä¼ è¿›åº¦ */
  .progress-container {
    height: 8px;
    background: #eee;
    border-radius: 4px;
    margin-top: 20px;
    overflow: hidden;
    display: none;
  }

  .progress-bar {
    width: 0%;
    height: 100%;
    background: var(--primary-color);
    transition: width 0.3s ease;
  }

  /* æ¶ˆæ¯æç¤º */
  .alertavater {
    padding: 15px;
    border-radius: 6px;
    margin-top: 20px;
    display: none;
  }

  .alertavater-success {
    background: #dff0d8;
    color: #3c763d;
  }

  .alertavater-error {
    background: #f2dede;
    color: var(--error-color);
  }
  input[type="file"] {
    display: none;
  }
 
</style>

<!-- lib -->

<!-- ä¾èµ–åº“ -->
<!-- å¼•å…¥ Litepicker æ ¸å¿ƒ CSS å’Œ JS -->

<script src="/dist/libs/litepicker/dist/js/litepicker.js"></script>

<script src="/dist/libs/cropper/cropper.min.js"></script>

<link href="/dist/libs/cropper/cropper.min.css" rel="stylesheet">

<!-- libs -->



<script>

  const avatar_dom = document.getElementById('myAvatar');
  function get_user_avatar() {

    const bgImage = avatar_dom.style.backgroundImage;
    // æ–¹æ³• 2ï¼šå­—ç¬¦ä¸²åˆ†å‰²
    const currentUrl = bgImage.split('url("')[1]?.split('")')[0];
    return currentUrl;
  }

  function set_user_avatar(str) {
    avatar_dom.style.backgroundImage = 'url("' + str + '")';
  }

  //å¤´åƒè£å‰ªå·¥å…·
  const avatar_toolt = new bootstrap.Modal('#avata_toolt');

  const birthdayPicker = new Litepicker({
    element: document.getElementById('birthday-picker'),
    lang: 'zh-cn', // è®¾ç½®ä¸ºä¸­æ–‡
    firstDay: 0, // å‘¨æ—¥ä¸ºé¦–æ—¥
    format: 'YYYY-MM-DD', // æ—¥æœŸæ ¼å¼
    maxDate: new Date(),  // æœ€å¤§æ—¥æœŸä¸ºä»Šå¤©
    dropdowns: {
      minYear: 1900,      // æœ€å°å¯é€‰å¹´ä»½
      maxYear: new Date().getFullYear(), // æœ€å¤§ä¸ºå½“å‰å¹´ä»½
      months: true,       // æ˜¾ç¤ºæœˆä»½ä¸‹æ‹‰
      years: true         // æ˜¾ç¤ºå¹´ä»½ä¸‹æ‹‰
    }
  });


  //å¤´åƒè£å‰ªåŒº
  let cropper;
  const image = document.getElementById('cropper-image');
  const message = document.getElementById('message');
  let currentScale = 1;
  var avatar_id = 0;

  // åˆå§‹åŒ–Cropper
  function initCropper(imageSrc) {
    if (cropper) {
      cropper.destroy();
    }

    image.src = imageSrc;
    cropper = new Cropper(image, {
      aspectRatio: 1,
      viewMode: 2,
      autoCropArea: 0.8,
      zoomable: true,
      zoomOnWheel: true,
      zoomOnTouch: true,
      wheelZoomRatio: 0.1,
      //minCanvasWidth: 400,
      //minCanvasHeight: 400,
      crop: updatePreview,
      ready() {
        updateImageInfo();
        document.querySelector('.progress-container').style.display = 'none';
      }
    });
  }



  // æ—‹è½¬æ§åˆ¶
  function rotateImage(degrees) {
    if (cropper) {
      cropper.rotateTo(cropper.getData().rotate + degrees);
      updatePreview();
    }
  }

  // æ›´æ–°é¢„è§ˆ
  function updatePreview() {
    const canvas = cropper.getCroppedCanvas({
      width: 250,
      height: 250,
      imageSmoothingQuality: 'high'
    });

    if (canvas) {
      canvas.toBlob(blob => {
        const previewUrl = URL.createObjectURL(blob);
        document.getElementById('preview-img').src = previewUrl;
        // æ¸…ç†æ—§URL
        setTimeout(() => URL.revokeObjectURL(previewUrl), 1000);
      }, 'image/png', 0.85);
      updateImageInfo();
    }
  }

  // æ›´æ–°å›¾ç‰‡ä¿¡æ¯
  function updateImageInfo() {
    if (cropper) {
      const data = cropper.getData();
      // document.getElementById('zoomValue').textContent = 
      //     `${Math.round(currentScale * 100)}%`;
      document.getElementById('imageSize').textContent =
        `${Math.round(data.width)} x ${Math.round(data.height)}`;
    }
  }

  // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
  document.getElementById('fileInput').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      showMessage('âš ï¸ è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      initCropper(reader.result);
      currentScale = 1;
    };
    reader.readAsDataURL(file);
  });

  // ä¸Šä¼ åŠŸèƒ½
  document.getElementById('uploadBtn').addEventListener('click', async () => {
    const progressBar = document.querySelector('.progress-bar');
    const progressContainer = document.querySelector('.progress-container');


    if (!cropper) {
      showMessage('âš ï¸ è¯·å…ˆé€‰æ‹©å¹¶è£å‰ªå›¾ç‰‡', 'error');
      return;
    }

    progressContainer.style.display = 'block';
    const canvas = cropper.getCroppedCanvas({
      width: 1024,
      height: 1024,
      imageSmoothingQuality: 'high'
    });

    const blob = await new Promise(resolve =>
      canvas.toBlob(resolve, 'image/png', 0.9)
    );

    post_file("/image", blob, `avatar.png`, (c) => {
      if (c.statusCode == 200) {
        if (c.data.err_code == 0) {
          showMessage(`âœ… ä¸Šä¼ æˆåŠŸ!`, 'success');
          avatar_id = c.data.return.id;
          set_user_avatar(c.data.return.preview);
          avatar_toolt.hide();

        } else {
          showMessage(`âŒ ä¸Šä¼ å¤±è´¥:` + c.data.err_msg, 'error');
          //banner_alert('warning', "æœåŠ¡é”™è¯¯", 3000)
        }
      } else {
        //banner_alert('danger', "ç½‘ç»œè¿æ¥é”™è¯¯ï¼š" + c.statusCode, 3000)
        showMessage(`âŒ ç½‘ç»œè¿æ¥é”™è¯¯:` + c.statusCode, 'error');
      }
    })

    // const formData = new FormData();
    //   formData.append('file', blob, `avatar_${Date.now()}.jpg`);
    //   formData.append('meta', JSON.stringify({
    //     width: canvas.width,
    //     height: canvas.height,
    //     scale: currentScale.toFixed(2)
    //   }));

    // const response = await fetch('/file/upload', {
    //   method: 'POST',
    //   body: formData,
    //   headers: {
    //     'X-Requested-With': 'XMLHttpRequest'
    //   }
    // });

    // if (!response.ok) throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);

    // const result = await response.json();
    // if (result.err_code == 0) {
    //   showMessage(`âœ… ä¸Šä¼ æˆåŠŸ!`, 'success');
    //   set_user_avatar(result.data.path);
    //   console.log(get_user_avatar());
    //   avatar_toolt.hide();
    // } else {
    //   showMessage(`âŒ ä¸Šä¼ å¤±è´¥: ${result.err_msg}`, 'error');
    // }





  });

  // æ¶ˆæ¯æç¤º
  function showMessage(text, type = 'success') {
    message.className = `alert alert-${type}`;
    message.textContent = text;
    message.style.display = 'block';
    setTimeout(() => message.style.display = 'none', 5000);
  }

  // æ¸…ç†èµ„æº
  window.addEventListener('beforeunload', () => {
    if (cropper) cropper.destroy();
    document.querySelectorAll('img').forEach(img => {
      if (img.src.startsWith('blob:')) URL.revokeObjectURL(img.src);
    });
  });

  // åˆå§‹åŒ–é»˜è®¤å›¾ç‰‡
  //initCropper('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=');

  //æ›´æ–°ç”¨æˆ·èµ„æ–™
  function updata_user_info() {
    post_json("/user/updata_info", {
      avatar_id: avatar_id,
      username: document.getElementById("username").value,
      first_name: document.getElementById("first_name").value,
      birthday: document.getElementById("birthday-picker").value,
    }, (c) => {
      if (c.statusCode == 200) {

        if (c.data.err_code == 0) {
          banner_alert('success', "æ›´æ–°æˆåŠŸ", 1000,()=>{
            location.reload();
          })

        } else {
          banner_alert('warning', "é”™è¯¯ï¼š"+c.data.err_msg, 1000)
        }



      } else {
        banner_alert('danger', "ç½‘ç»œè¿æ¥é”™è¯¯ï¼š" + c.error, 10000)
      }
    });
    // const url = '/api/v1/user/updata_info';
    // const sumt_data = {
    //   avatar: get_user_avatar(),
    //   avatar_id:avatar_id,
    //   username: document.getElementById("username").value,
    //   first_name: document.getElementById("first_name").value,
    //   birthday: document.getElementById("birthday-picker").value,


    // };
    // try {
    //   const response = axios.post(url, sumt_data, {
    //     headers: {
    //       'Content-Type': 'application/json'
    //     }
    //   }).then(response => {
    //     //console.log(response)
    //     if (response.data.err_code == 0) {
    //       location.reload()
    //     } else {
    //       console.log(response.data)
    //     }

    //   });
    // } catch (error) {
    //   if (error.response) {
    //     // æœåŠ¡å™¨è¿”å›äº†é”™è¯¯çŠ¶æ€ç ï¼ˆå¦‚ 4xx, 5xxï¼‰
    //     console.error('æœåŠ¡å™¨é”™è¯¯:', error.response.data);
    //   } else {
    //     console.error('è¯·æ±‚æœªå®Œæˆ:', error.message);
    //   }
    // }

  }
</script>